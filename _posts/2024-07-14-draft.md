---
layout: post
title: "timeclock in terminal (terminal)"
author: "melon"
date: 2024-07-03 07:11
categories: "2024"
tags:
  - terminal
---


1) register sig handler inside child proc for different process control purpose
```text
// gcc -o out t.c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>
#include <sys/wait.h>

void handle_sigusr1(int signum){
    system("uptime");
}

void handle_sigtstp(int signum){
    exit(0);
}

void bgTask(){
    signal(SIGUSR1, handle_sigusr1);
    signal(SIGTSTP, handle_sigtstp);
    while(1){
        pause();  // wait for signals
    }
}

int main(){
    pid_t pid = fork();
	if(pid < 0){
        perror("fork");
        return 1;
    }
	else if(pid == 0){  // child
        bgTask();
    }
	else{  // parent
        printf("Task bgTask %d started!\nYou could trigger them by\n  - kill -USR1 %d\nThen you could stop them by\n  - kill -TSTP %d\n", pid, pid, pid);
        wait(NULL);    // Wait for child process to finish
    }
    return 0;
}

// test cases

// mac@MacBook-Pro tty-clock % ./out &
// [1] 6046
// mac@MacBook-Pro tty-clock % Task bgTask 6047 started!
// You could trigger them by
//   - kill -USR1 6047
// Then you could stop them by
//   - kill -TSTP 6047

// mac@MacBook-Pro tty-clock % kill -USR1 6047
// mac@MacBook-Pro tty-clock % 18:44  up 22:41, 2 users, load averages: 2.44 2.30 2.48
// kill -USR1 6047
// mac@MacBook-Pro tty-clock % 18:44  up 22:41, 2 users, load averages: 2.44 2.30 2.48
// 
// mac@MacBook-Pro tty-clock % kill -TSTP 6047
// mac@MacBook-Pro tty-clock %
// [1]  + done       ./out
```

2) execute shell script & cmd inside child process, and wait in parent process,
return the pid/status of the execution.

```text
// $ gcc -o out x.c
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>     // _exit
#include <stdio.h>

// execute shell cmd & return pid and execute status
void exec_shell_script(const char* cmd, int* out_status, pid_t* out_pid){
    pid_t pid = fork();
    if(pid == -1){
        perror("fork");
        return;
    }
    else if(pid == 0){
        execl("/bin/sh", "sh", "-c", cmd, (char*) NULL);
        perror("execl");
        _exit(127);
    }
    else{
        int status;
        if(waitpid(pid, &status, 0) == -1){
            perror("waitpid");
            return;
        }
        if(out_status){
            *out_status = status;
        }
        if(out_pid){
            *out_pid = pid;
        }
        return;
    }
}

int main(){
    const char* cmd = "./tty-clock -s -c";
    int status;
    pid_t pid;

    exec_shell_script(cmd, &status, &pid);
    if(!WEXITSTATUS(status)){
        printf("shell cmd succeed.\n");
        printf("pid: %d\n", pid);
        printf("status: %d\n", WEXITSTATUS(status));
    }
    else{
        printf("shell cmd failed.\n");
    }
    return 0;
}

// $ ./out
// shell cmd failed.

// $ gcc -o out x.c
// $ ./out
// LICENSE   out     shell.c  test.c  tt.sh      tty-clock.1  ttyclock.h  x.c   y.sh
// Makefile  readme  sig.c    t.sh    tty-clock  ttyclock.c   x.          x.sh
// shell cmd succeed.
// pid: 13277
// status: 0
```


3) another ways to invoke shell script & command in c:

```text
// execute shell command & script in c
// gcc -o out test.c
#include <stdio.h>
#include <stdlib.h>

void exec_shell_cmd(const char* cmd){
    char buffer[128];
    FILE* pipe = popen(cmd, "r");
    if(!pipe){
        fprintf(stderr, "popen() failed!\n");
        return;
    }
    while(fgets(buffer, sizeof(buffer), pipe) != NULL){
        printf("%s", buffer);
    }
    pclose(pipe);
}

int exec_shell_script(const char* cmd){
    int status = system(cmd);
    return status;
}

// job control
int main(){
    // exec_shell_cmd("fg %1");          // ./out => sh: line 0: fg: no job control
    // exec_shell_cmd("./clock.sh");     // ./out & => sleep is still in bg

    // exec_shell_script("./clock.sh");  // same as above
    // exec_shell_script("ls -l");       // see below
    return 0;
}

// clock.sh
// #!/bin/sh
// set -m          # mind this option
//
// sleep 10 &
// fg %1

// total 192
// -rw-r--r--  1 mac  staff   1545 Jul 12 22:27 LICENSE
// -rw-r--r--  1 mac  staff   1715 Jul 12 22:31 Makefile
// -rwxr-xr-x  1 mac  staff     65 Jul 14 19:12 clock.sh
// -rwxr-xr-x  1 mac  staff     22 Jul 14 19:07 k.sh
// -rwxr-xr-x  1 mac  staff  13060 Jul 14 19:13 out
// -rw-r--r--  1 mac  staff   4099 Jul 12 22:27 readme
// -rw-r--r--  1 mac  staff    743 Jul 14 19:13 shell.c
// -rw-r--r--  1 mac  staff    420 Jul 14 18:53 sig.c
// -rw-r--r--  1 mac  staff   2906 Jul 14 18:28 test.c
// -rw-r--r--  1 mac  staff   3193 Jul 12 22:27 tty-clock.1
// -rw-r--r--  1 mac  staff  20738 Jul 12 22:27 ttyclock.c
// -rw-r--r--  1 mac  staff   4359 Jul 12 22:27 ttyclock.h
// -rw-r--r--  1 mac  staff    889 Jul 14 18:59 x.sh
// -rwxr-xr-x  1 mac  staff    739 Jul 14 18:59 y.sh
```
