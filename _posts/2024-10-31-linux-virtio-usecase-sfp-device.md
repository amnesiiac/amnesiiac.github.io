---
layout: post
title: "virtio usecase: hot-plug sfp device emulation (linux, virtualization, driver)"
author: "melon"
date: 1111-10-31 21:44
categories: "2024"
tags:
  - linux
  - virtualization
  - todo
---

### # device simulation architecture overview

```blurtext

          ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
          │ setup container                                                                                             │
          │              ┌────────────────────────────────────────────────────────────────────────────────────────────┐ │
          │              │ olt-1 container                                                                            │ │
          │              │                                                                                            │ │
          │              │   ┌───────────────────────┐                                                                │ │
          │              │ ┌-┤ board hotplug service │                                                                │ │
          │              │ | └───────────────────────┘                                                                │ │
          │              │ | ┌──────────────────────────────────────────────────────────────────────────────────────┐ │ │
          │              │ | │ lt-1 board container                ┌──────────────────────────────────────────────┐ │ │ │
          │              │ | │                  ┌────sfp─────┐     │ VMM process         ┌──────────────────────┐ │ │ │ │
  RESTful │ ┌──────────┐ │ | │           ┌-gmsg-┤ vhost-user ├-uds-│┐                    │ VM (board build)     │ │ │ │ │
    API   │ │ dev-mgnt ├-│-┘ │ ┌─────────┴──┐   │  backend   │     │| ┌────────────┐     │ ┌────────┐ eqpt┬apps │ │ │ │ │
 ---------│-┤ service  ├-│---│-┤ gshell msg │   └────────────┘     │└-┤ vhost-user │vring│ │ virtio │  ┌──┴───┐ │ │ │ │ │
          │ └──────────┘ │ ┌-│-┤   proxy    │   ┌─other─dev──┐     │┌-┤   client   ├-----│-┤ driver ├--┤ udrv │ │ │ │ │ │
          │              │ | │ └─────────┬──┘   │ vhost-user │     │| └────────────┘     │ └────────┘  └──────┘ │ │ │ │ │
          │              │ | │           └-gmsg-┤  backend   ├-uds-│┘                    └──────────────────────┘ │ │ │ │
          │              │ | │                  └────────────┘     └──────────────────────────────────────────────┘ │ │ │
          │              │ | └──────────────────────────────────────────────────────────────────────────────────────┘ │ │
          │              │ |                                                                                          │ │
          │              │ | ┌──────────────────────────────────────────────────────────────────────────────────────┐ │ │
          │ ┌──────────┐ │ | │ nt-1 board container                ┌──────────────────────────────────────────────┐ │ │ │
          │ │ devmodel │ │ | │                  ┌────────────┐     │ VMM process         ┌──────────────────────┐ │ │ │ │
          │ │ service  ├-│-┘ │           ┌-gmsg-┤ vhost-user ├-uds-│┐                    │ VM (board build)     │ │ │ │ │
          │ ├──────────┤ │   │ ┌─────────┴──┐   │  backend   │     │| ┌────────────┐     │ ┌────────┐ eqpt┬apps │ │ │ │ │
          │ │    db    │ │   │ │ gshell msg │   └────────────┘     │└-┤ vhost-user │vring│ │ virtio │  ┌──┴───┐ │ │ │ │ │
          │ └──────────┘ │   │ │   proxy    │   ┌────────────┐     │┌-┤   client   ├-----│-┤ driver ├--┤ udrv │ │ │ │ │ │
          │              │   │ └─────────┬──┘   │ vhost-user │     │| └────────────┘     │ └────────┘  └──────┘ │ │ │ │ │
          │              │   │           └-gmsg-┤  backend   ├-uds-│┘                    └──────────────────────┘ │ │ │ │
          │              │   │                  └────────────┘     └──────────────────────────────────────────────┘ │ │ │
          │              │   └──────────────────────────────────────────────────────────────────────────────────────┘ │ │
          │              │                                                                                            │ │
          │              │   ┌──────────────────────────────────────────────────────────────────────────────────────┐ │ │
          │              │   │ xxx board container             ...                                                  │ │ │
          │              │   └──────────────────────────────────────────────────────────────────────────────────────┘ │ │
          │              └────────────────────────────────────────────────────────────────────────────────────────────┘ │
          │                                                                                                             │
          │              ┌────────────────────────────────────────────────────────────────────────────────────────────┐ │
          │              │ olt-2 container                     ...                                                    │ │
          │              └────────────────────────────────────────────────────────────────────────────────────────────┘ │
          │                                                                                                             │
          └─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

```

<hr>

### # board build in vm: add kdrv & udrv support
1 virtio device driver: basic read / write / init / probe...  
2 udrv service: some adaptions will take place on udrv config & src, to enable udrv correctly proxied the virtio
device operations from the upper eqpt-mgnt apps.
