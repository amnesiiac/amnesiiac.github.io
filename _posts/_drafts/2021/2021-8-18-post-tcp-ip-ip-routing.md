---
layout: post
title: "tcp-ip: ip routing (IP最重要的功能之一)"
subtitle: '[tcp-ip: illustrated vol1] - chapter9' 
author: "twistfatezz"
header-style: text
# header-img: "img/in-post/economics_1/headimg.png"
# header-mask: 0.8
comments: false 
mathjax: false 
date: 2021-08-18 10:13
lang: ch 
catalog: true 
categories: tcp-ip 
tags:
  - Time 2021
  - tcp-ip illustrated vol1 
---
### 一：简介
选路(routing)是IP最重要的功能之一，需要进行选路的数据报可以由本地产生，也可以由其他主机产生。后者要求主机被配置成一个路由器，否则如果通过网络接口收到的数据报的目的主机不是当前主机，则该数据报会被丢弃(sliently discarded)。

**IP路由守护程序的工作进程示意图**
<center><img src="/img/in-post/tcp-ip_img/routing_1.pdf" width="70%"></center>

### 二：选路的原理
在chapter3中曾经描述了IP搜索路由表的几个步骤：**1** 搜索与收到的数据报相互匹配的主机地址；**2** 搜索与之匹配的网络地址；**3** 搜索默认表项(default entry)，默认表项一般在路由表中被指定为一个网络表项(network entry)，其网络号为0(network ID=0)。

IP层进行选路实际上是应用了选路机制(routing mechanism)，选路机制即搜索路由表并决定向哪个网络接口发送数据报分组。选路机制和选路策略(routing policy)是不同的，选路策略是一组决定将哪些路由加入到路由表的规则。

IP提供选路机制，但是内核中的路由守护程序则提供了选路策略。

##### 1 简单的路由表解析 - 使用netstat命令打印svr4主机路由表
<center><img src="/img/in-post/tcp-ip_img/routing_2.pdf" width="100%"></center>

**关于netstat命令打印的输出的补充说明** <br>
**[1] 子网掩码(subnet mask和interface IP address共同决定了主机号)** <br> 内核程序知道每个路由表项对应的接口，并且路由表项的子网掩码默认是接口的子网掩码。一般地，路由表子网掩码可以是任何32bit的数值，如需使用默认子网掩码以外的数值，需要通过路由名的选项进行指定。 

**[2] 关于影响路由表的复杂度的影响因素** <br>
**(i)** 最简单但是最不令人感兴趣情况：主机没有和任网络相连接。TCP/IP协议簇可以应用于这类主机，但主机只能和自己通信：路由表只包含一项环回接口(lo0)。<br>
**(ii)** 较复杂一点的情况是：主机位于一个局域网上，且只能连接到局域网内的主机。此时路由表包含2项：一项是环回接口(lo0)，另一项是局域网络(network ID)。<br>
**(iii)** 更加复杂的情况是：主机位于一个局域网上，且该局域网有1个路由器可以访问其他网络(Ethernet)。此时路由表需要增加增加一个默认表项(default)指向该路由器。<br>
**(iv)** 最后的情况：当主机能够访问其他"host-specific"或者"network-specific"的路由器。在上述netstat案例中，svr4主机通过bsdi路由器的路由表路由到slip主机就是一个这样的案例。

##### 2 根据svr4主机路由表为特定数据报分组进行IP选路
首先给定主机网路结构如下图所示(剪裁自chapter1通用网络结构)：
<center><img src="/img/in-post/tcp-ip_img/routing_3.pdf" width="60%"></center>

下面为特定目的地址的IP数据报选择svr4主机上的特定路由表项：<br>
**(i)** 目的地址为sun主机地址：140.252.13.33。首先进行主机地址的匹配：路由表中"final destination"中的主机地址项(localhost、slip)均不匹配。接着进行网络地址匹配：匹配到140.252.13.32(网络号和子网号都相同)，因此主机使用emd0接口发送该数据报。根据Flags结合上面的网络结构图易知这是一个直接路由，IP数据报中的硬件地址为目标主机sun的MAC地址。<br>
**(ii)** 目的地址为slip主机地址：140.252.13.65。首先进行主机地址的匹配：路由表中"final destination"中主机地址项(slip)完美匹配。根据Flags结合网络结构图易知这是一个间接路由，IP数据报中的硬件地址为"临时目的主机"的MAC地址。<br>
**(iii)** 目的地址为internet中的地址aw.com(197.207.117.2)。首先进行主机地址匹配，失败；然后进行网络地址匹配，失败；最终找到默认表项(default)。这是一个间接路由，通过网关(sun:140.252.13.33)进行转发，并使用接口emd0。<br>
**(iv)** 最后，向本机发送一封IP数据报，有四种方式可以完成："ftp svr4(主机名)"、"ftp 140.252.34(主机IP地址)"、"ftp localhost(环回IP)"、"ftp 127.0.0.1(环回地址)"。其中\<前两种方式\>首先进行主机名匹配(失败)；然后进行网络匹配(成功)，数据报被送到路由表中的网络号、子网号都匹配的地址140.252.13.32，当IP数据报经由以太网驱动程序处理时(处理流程参考chapter2-环回接口部分)，被送回环回接口，放到IP输出队列中。\<后两种方式\>由于指定了环回接口名字、环回地址，在主机名匹配时即可找到相应表项，IP数据报直接送到环回驱动程序，驱动程序将报文放到IP输出队列中。要注意前后两类方式的区别。

##### 3 路由表的初始化
**1 为路由表添加直接路由(G)**。每当初始化一个接口时(如：用ifconfig命令设置接口地址)，自动在路由表中添加一个直接路由。对于点对点链路和环回接口而言，路由连接到主机(路由表中设置H标志)；对于广播接口而言，路由连接到网络(路由表中无需设置H标志)。<br>
**2 为路由表中添加间接路由(non-G)**。某种程度上，某个主机或者网络的路由如果不是和本机直接相连的，就必须加入到路由表中。一种添加的方式是在系统引导(bootstrapped)时，手动在初始化文件中执行"route"命令。在svr4主机上，可通过如下命令添加路由表项："route add default sun 1"、"route add slip bsdi 1"，后三个参数分别为："destination、gateway、routing metric"，当路由度量(routing metric)大于0时，为该路由设置G标志，路由度量等于0时，不设置G标志。<br>
**3 为路由表中添加默认路由** 一些系统中允许在某个特定文件中指定默认路由(default)，比如"/etc/defaultrouter"，在每次重新启动系统(reboot)时都要将此文件中的默认路由表项添加一遍。<br>
**4 路由初始化的其他方式** 初始化路由表的其他方式是路由守护程序(chapter10)，或者使用路由发现协议(chapter9.6)。

##### 4 netstat+ifconfig查看sun主机路由表的案例
<center><img src="/img/in-post/tcp-ip_img/routing_4.pdf" width="100%"></center>

##### 5 路由表中找不到和目标地址相匹配的表项
当路由表中没有和需要路由的数据报IP地址相匹配的表项，但是又没有提供默认表项，会发生什么情况呢? <br>
**1** 如果IP数据报是主机产生的，那么就给发送该数据报的应用程序返回一个"主机不可达ICMP差错报文"或者是"网络不可达ICMP差错报文"。<br>
**2** 如果IP数据报在当前主机被转发(本机作为router)，那么给原始发送端发送一份ICMP主机不可达报文(在本文下一部分进行详解)。<br>

### 三：主机不可达ICMP报文 & 网络不可达ICMP报文
由于gateway路由器是两个LAN网络连接到互联网的网关(router)，所以gateway是两个LAN所有主机的默认主机。根据之前在sun主机上运行netstat命令输出结果：当与sun主机相连SLIP线路连接时，sun主机的路由表项包含一个使用SLIP线路的表项，当SLIP线路断开时，从sun主机的路由表项中删除该项。<br>
sun主机中的连接到LAN(140.252.1.183)的项目为路由表中的默认表项。如果SILP线路断开，此时sun主机接收到一个发往internet的IP数据报，则由于直接与sun主机相连的主机、网络无法匹配，需查找默认表项，此时默认表项已经删除，sun主机返回一个"ICMP主机不可达"or"ICMP网络不可达报文"。

### 四：IP数据报的转发 & 不转发
一般情况下，都假定主机不转发IP数据报，转发数据报的称之为路由器，但是主机也可以进行特殊配置作为路由器使用。<br>
大多数BSD系列的系统维护一个内核变量"ipforwarding"(或者类似的其他名字)：一些系统(BSD/386和svr4)只有在ipforwarding不为0时才转发给数据报，SunOS 4.1.x允许该变量有3个不同的数值：-1始终不转发IP数据报，也不改变ipforwarding的数值；0表示默认情况下不转发，当有至少2个以上接口开启时，就把ipforwarding设置为1；1表示始终转发。

### 五：ICMP重定向错误数据报
当路由器收到一封本不应该发给自己的IP数据报时，它就发送一封ICMP重定向错误(redirect error)数据报给IP数据报的发送者(sender)。<br>
下图展示了ICMP重定向数据报的一种简单机制：
<center><img src="/img/in-post/tcp-ip_img/routing_5.pdf" width="100%"></center>

根据上图，简单解析ICMP重定向报文的产生发送机制：<br>
**(step-1)** 路由器router#1是主机的默认路由，假定主机发送一封IP数据报给router#1<br>
**(step-2)** 路由器router#1收到IP数据报并检查它的路由表，发现router#2是该IP数据报的下一站。因此路由器router#2将IP数据报转发给主机(此时路由器发现IP数据报接收的接口和发送的接口相同 - "自己多余的")，主机收到IP数据报后转发给路由器router#2。因此需要通知主机给router#2路由器发送IP数据报时不要经过router#1。<br>
**(step-3)** 路由器router#1发送一封ICMP重定向数据报给主机，通知主机发送IP数据报给路由器router#2时，不要经过路由器router#1。

**ICMP重定向机制的用途** <br>
ICMP重定向数据报一般用来让具有非常少的路由信息的主机逐渐建立完善的路由表。ICMP重定向机制可以允许网络中的主机使用dumb的构建路由表逻辑(不需要具备复杂的高级功能)，而将需要灵活、智能实现的部分放在路由器端。比如连接在LAN上的所有主机在启动时只需使用一个默认路由，然后路由表项中的其他项目都通过ICMP重定向机制进行学习获得。

##### 1 ICMP重定向机制的例子
**[1] 问题** 给定chapter1中建立的主机网络结构如下图所示，子网#1中的主机如何访问子网#2中的主机呢？
<center><img src="/img/in-post/tcp-ip_img/routing_6.pdf" width="80%"></center>

**(i)** 如果子网#2中只有一台主机sun，那么可以将netb配置成sun主机的ARP代理，将子网#1中的主机的ARP高速缓存中sun主机的MAC地址设置为netb的代理硬件地址。<br>
**(ii)** 当子网#2为一个网络而不是单个主机时，无法通过配置子网#1的ARP代理以实现代理任意访问子网#2的主机，此时可以通过在子网#1中为每个主机配置静态路由选项来实现，也可以通过在每个主机上运行路由守护程序来实现；另一种较为简单的方法是：借助ICMP重定向机制来实现。

**[2] 在运行ping程序之前的solaris主机上的路由表如下图所示**
<center><img src="/img/in-post/tcp-ip_img/routing_7.pdf" width="100%"></center>

**[3] 在子网#1中的solaris主机上运行ping程序到子网#2中的bsdi主机并打印输出结果如下**：
<center><img src="/img/in-post/tcp-ip_img/routing_8.pdf" width="100%"></center>

**[4] solaris调用ping程序接收到ICMP重定向报文之后再次打印主机路由表如下图所示**<br> 下图中加粗的项目是在ping程序发送ICMP重定向数据报而新增的路由表项目(标志D说明了这一点)。
<center><img src="/img/in-post/tcp-ip_img/routing_9.pdf" width="100%"></center>
由于ICMP重定向报文收到而在路由表中新添加的项目只能处理从源主机solaris到特定目的主机bsdi的路由项目，如果想要访问svr4主机，就需要产生另一封ICMP重定向报文。

保存在solaris主机上的关于子网#2的4台主机的路由项可以通过一个指向sun主机的目的地址为网络号(140.252.13)来统一表示，但是创建ICMP重定向的主机并不知道子网#2的网络结构信息，因此，ICMP重定向报文无法在solaris路由表中创建网络路由(network routing)，只能创建主机路由(host routing)。

##### 2 关于ICMP重定向报文的一些细节
**[1] ICMP重定向报文格式**
<center><img src="/img/in-post/tcp-ip_img/routing_10.pdf" width="80%"></center>

**[2] ICMP重定向报文的接受者必须查看3个IP地址** <br>
**(i)** 引发重定向机制的IP数据报的源IP地址，即ICMP重定向报文中数据部分存储的IP首部。**(ii)** 发送ICMP报文的路由器的IP地址，即包含ICMP重定向报文的IP数据报的源地址。**(iii)** 应当采用的路由器IP地址，即ICMP数据报中的4～7byte。 

**[3] ICMP重定向报文的规则** <br>
**(i)** ICMP重定向报文只能由路由器产生，不能由主机产生；重定向报文也是为路由器使用而不是主机使用的。**(ii)** 假定路由器同其他路由器共同参与某种选路协议，则该协议就应该负责消除使用重定向机制的需要，即如本文前面的IP守护程序流程图中展示的那样，路由表中的表项应该能够被选路守护程序更改or删除，也可以被重定向报文更改，但是不能同时被两这修改。

**[4] BSD-4.4系统主机作为路由器生成ICMP报文之前需满足的必要条件** <br>
**(i)** 引发ICMP重定向报文的IP数据报的输入接口=输出接口。**(ii)** 用于向外传送数据报的路由表项不能被ICMP重定向报文创建or修改过，也不能是路由器的默认路由。**(iii)** 数据报不能用源站选路的方式进行转发。**(iv)** 内核必须配置or允许发送ICMP重定向报文。

**[5] BSD-4.4系统在根据重定向报文修改路由前需要做如下检查(防止路由器or主机误操作、用户恶意破坏)** <br>
**(i)限定去向** 重定向的新的路由器必须在一个和本机直接相连的网络上。**(ii)限定来源** ICMP重定向报文必须来自重定向发生之前的路由表项中目的地对应的路由器。**(iii)** 重定向报文不能选择主机本身作为路由器。**(iv)** 路由表项中被替换路由必须是一个间接路由。

**[6] 关于ICMP重定向的注意事项** <br>
路由器应当只发送针对主机的重定向(code=1/3)，而不是对于网络的重定向(code=2/4)。由于子网的存在，使得难以判断在什么情况下应当发送网络重定向。一些主机将接收到的网络重定向报文当作主机重定向来处理，以防该网络重定向报文是由于路由器发送了错误的code类型而产生。

### 六：ICMP路由发现报文
本文之前提到了一种初始化路由表的方式，即在路由配置文件中通过"ifconfig命令"、"route add命令"添加路由表项。但是上述方式一般用来添加默认路由表项。另一种方式是使用ICMP通知&请求数据报。

一般地，主机在完成系统引导(bootstrapping)后，通过广播、多播的方式发送一封ICMP请求(solicitation)报文，一台或多台路由器响应该请求报文，并将通知信息添加到响应报文中。另外，路由器会定时以广播、多播的方式发送它们的通知报文，允许每个监听的主机定期更新它们的路由表项。

##### 1 ICMP路由请求报文格式(RFC-1256) - receiver广播&多播形式发送
<center><img src="/img/in-post/tcp-ip_img/routing_11.pdf" width="60%"></center>
##### 2 ICMP路由通知报文格式(RFC-1256) - sender广播&多播形式发送
<center><img src="/img/in-post/tcp-ip_img/routing_12.pdf" width="60%"></center>

##### 3 路由器相关操作(router operations)
**(i)** 当路由器启动时，定期通过所有广播&多播接口发送ICMP路由通知报文。准确地说，这些通知报文不是定期发送的，而是随机发送的，这么做的目的是：为了减小所发送的ICMP通知报文与子网上其他主机的报文相互冲突的概率。一般两次发送ICMP通知报文的间隔时间为450s或600s，一份ICMP通知报文的生命期为30min。<br>
**(ii)** ICMP通知报文中的生存时间有一个重要的用法是：用来通知子网其他主机当前路由器的某个接口已经关闭。具体做法是：在该接口关闭前，使用该接口发送一封通知报文，并设置报文的生存时间=0。<br>
**(iii)** 除了定期发送通知报文以更新子网其他主机的路由表项，路由器还要监听ICMP请求报文，并发送ICMP通知报文以响应这些请求。<br>
**(iv)** 最后，对于同一子网中含有多台路由器的情况，网路系统管理员负责设置每台路由器的优先级：如主默认路由器的优先级要高于备份路由器。

##### 4 主机相关操作(host operations)
**(i)** 在主机引导期间(bootstrapping)，一般发送3封ICMP路由请求报文，每隔3s发送一封，一旦收到一个有效的ICMP路由通知报文，就停止发送请求报文。<br>
**(ii)** 主机需要监听与之相邻的路由器的ICMP路由通知报文，这些通知报文可以改变主机的默认路由器。另外，如果没有收到当前路由表项中默认路由(default)的通知报文，则显示默认路由超时。<br>
**(iii)** 只要默认路由表项处于"UP"状态(FLAGS=U)，主机就会每隔10min发送生存时间为30min的ICMP通知报文。这意味着，即使3份ICMP通知报文中的两份丢失了，也不会引起主机默认路由超时。

### 小结
IP路由相关操作对于主机&路由器来说是最基本的。系统产生or转发每份数据报都要搜索路由表。路由表可以被路由守护程序(darmon)以及ICMP重定向报文进行自动地修改，也可以通过手动调用route命令添加默认表项。主机默认不会转发数据报，除非对该主机进行了特殊配置。


## Reference
> \<tcp-ip: illustrated vol1\> chapter9 <br>

> 1 当使用inline数学公式且公式经过GFM排版之后都在同一行 使用`$...$`符号<br>
> 2 当希望数学公式单独成行或者经过GFM排版之后占用多行 应当使用`$$...$$`符号<br>
> 3 对于表示条件概率 需要表示竖线的时候`|` 应当使用`\mid` 而不是直接在键盘上打出`|` => 容易被编辑器认为是一个md制表符<br>
> 4 在md引入图片的时候 不要使用`<center>`和`</center>` 在这篇文档的编辑过程中vscode的preview插件在使用了上述符号之后 导致下一段的数学公式预览显示不正常<br>
> 5 使用md的时候 单独的两段文字上下需要空出一行<br>
> 6 想要强制换行的时候 需要使用`<br>`而不是`<enter>`<br>
> 7 特殊字符如果想要避免和md解析关键字冲突 应当使用``将关键字包含在内 <br>
> 8 `<center><img src="/img/in-post/economics_4/xxx.png" width="60%"></center>` <br>
> 9 使用html设置图片文字环绕方式: <br>
    `<div>` <br>
        `<img src="/img_path" align="left" width="40%" hspace="" vspace=""/>` <br>
        `<p>paragraph1 around the picture</p>` <br>
        `<p>paragraph2 around the picture</p>` <br>
        `<p>paragraph3 around the picture</p>` <br>
    `</div>` <br>
> 10 `<font style="color:red; font-weight:bold">加粗蓝色</font>`用来设置字体颜色 <br>
> 问题脚注: ### ??????problem😫problem??????
