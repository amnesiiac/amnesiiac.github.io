---
layout: post
title: "cpp - linkage"
subtitle: '链接性相关知识整理'
author: "twistfatezz"
header-style: text
# header-img: "img/in-post/economics_1/headimg.png"
# header-mask: 0.8
comments: false 
mathjax: true
date: 2021-05-06 14:45
lang: ch 
catalog: true 
categories: cpp 
tags:
  - Time 2021
  - cpp fundermentals
---
### 什么是链接性?
链接性(linkage)是程序编译时，程序中的名字(name，也可称标识符identifier)在作用域中不同位置的出现能够绑定到同一对象或函数。在c++中，链接性描述了名字在整个程序或单独编译单元中能否绑定到同一实体(entity)。

### 静态(内部)链接性

具有内部链接性的名字，在编译后不会产生链接符号(或者称修饰名字)，在符号表中为LOCAL符号，因此不与链接器打交道。

**[具有内部链接性的几种情况]** <br>
`1` 所有的**声明**。 <br>
`2` 命名空间(包括全局命名空间)中的**static自由函数**。 <br>
`3` 命名空间(包括全局命名空间)中**static友元函数**、**static变量**的定义。 <br>
`4` 命名空间(包括全局命名空间)中**const常量**定义。 <br>
`5` **enum**定义。 <br>
`6` **inline函数**定义(包括自由函数和非自由函数)。 <br>
`7` 类(**class**、**struct**、**union**)的定义。 <br>
`8` **补充4** c++隐式把具有const限定的命名空间中的变量处理为内部链接性，除非在const限定声明之时或之前已经声明为extern。<br>

### 外部链接性
外部链接性(external linkage)也称为全局链接性(global linkage)，编译后在符号表中是GLOBAL符号。具有全局链接性的名字可以在不同编译单元声明并绑定到同一实体。

**[具有外部链接性的几种情况]** <br>
`1` 非inline函数：包括命名空间中**非static函数**、**类成员函数**和**类static成员函数**。<br>
`2` **类static成员变量**总有外部链接性。<br>
`3` 命名空间(不包括无名命名空间)中**非static变量**。 <br>
`4` 命名空间中的func隐式的具有extern属性。

### 内部链接性和外部链接性的区别
外部链接性意味着：函数或者全局变量在整个工程文件中都是accessible的。内部链接性表明：相应的变量或者函数只能在一个**编译单元**中是accessible。内部链接性和外部链接性主要讲的是变量的作用域是否局限于单个编译单元，不局限的就是外部，局限的就是内部。具有内部链接性的变量在同一个编译单元中只能有一个定义，如果被定义了多次则引发链接错误；内部链接性变量在不同的编译单元中被包含(定义)，不会引发错误。具有外部链接性的变量在不同编译单元中只能有一个定义，如果定义了多次(如被多个编译单元中的文件包含)则引发编译错误。

外部链接性的东西在声明和定义的时候，需要考虑工程中全局的链接的合理性，不同的编译单元中的声明相同的东西因其具有外部链接性，而被链接到一起做编译期优化。具有内部链接性的东西在声明和定义的时候，需要考虑工程中单个编译单元中链接的合理性，在同一个编译单元中声明相同的东西会因其内部链接性而被链接到一起进行优化。

关于编译单元相关知识，在下面进行简单整理。

**[关于编译单元 - 源文件所有依赖包含构成 - 类似module]** 编译单元(compilation unit)，也可以被称为translation unit，是进过预处理程序之后，用于传给c/c++编译器做进一步处理的最终输入；编译单元文件中：头文件中#include中包含的代码段已经被引入，宏已经被展开替换。<br>
编译单元定义了一种文件域，其功能和文件域所包含的范围和**module**类似。c语言没有**module**的概念，如果源文件(source file)只有一个文件，则此时，编译单元和已经包含了所有头文件的当前源文件相同(退化成单文件作用域)。

**[单个编译单元 - 编译过程中重复代码优化手段]** <br>
**➤ problem:** 在c/c++中编译模型中，单个的源文件(.c/.cpp/.cxx)被预处理成一个编译单元，这些分开的编译单元随后被编译成很多目标文件(object file/.o/.obj)，这些目标文件通过链接器链接在一起，创建成一个可执行文件或者lib。不难发现，在上述程序进行处理的过程中，对于共享的头文件(变量、函数的定义，模版等)可能会被分别的编译、链接很多次。<br>
**➤ solve the problom:** 单个编译单元(single complilation unit)是一种能够提高编译器在多文件下的编译效率的技术。单个编译单元能够让文件中数据部分和共享头文件中的各种定义、模版相分离，通过内部、外部链接性质使得编译器在使用相应方法时，无需重复的创建共享的内容，从而节省了时间提升了编译效率。这种技术可以在整个工程中使用(称之为unity build)，也可以在部分源文件中进行使用。<br>
**➤ drawbacks-1:** 单编译单元技术在编译期(不在链接期)使用预处理器指令集将不同的编译单元合在一起，降低了整体工程的建立的时间(减少了重复编译工作)，但是这种单编译单元技术缺点：即使是单个源文件改动，也可能会导致整个单元的rebuild。因此，单编译单元技术适合`不经常改动的`以及`有很大的overlap`的源文件的编译，或者适合那些本身就需要定期绑定一起进行rebuild的源文件集合。<br>
**➤ drawbacks-2:** 单编译单元技术另一个缺点是：它是串行的，在单个进程中按照顺序编译所有的源文件，就像是每个源文件分别在编译一样。想要进行并行编译，需要手动分区，将完全没有依赖的东西分成不同的区，进行并行编译。<br>
**➤ complements:** 单编译单元技术在编译器没有`执行链接时间优化`(上述内容)的情况下，进行`执行过程间优化`(如inline优化、避免异常、副作用、寄存器分配导致的隐式代码膨胀)。

**[关于代码组织风格简述]** 项目代码的大部分通常保存在：带有.cpp后缀的文件中(也有其他后缀.cxx或.cc)；源文件中包含的文件通常带有.h后缀(或者.hpp或.hh，也可包含.cpp文件)，并且**通常**不包含函数或变量定义，以避免**头文件被包含在多个源文件中**而出现名称冲突。头文件可以并且经常包含在其他头文件中。一般而言，项目中的源文件至少包含项目中的一个头文件。

### 函数链接性
**[类型安全链接]** c++中有一种机制(type-safe-linkage)，通过它可以把函数参数的类型和数目编码在函数名中，称之为`类型安全链接`(type-safe-linkage)。类型安全链接可用来帮助捕捉不同文件中函数声明不匹配的情况。不同文件中出现的同一对象或函数声明的其他类型不匹配情况，在编译或链接时可能不会被捕捉到(只能在程序运行时异常or产生错误输出时被发现)。因为编译器一次只能处理一个编译单元，它不能很容易地检查到编译单元之间的类型违例，这些类型违例可能是程序严重错误的根源。

### 跨语言链接性
不同编程语言对同一名字编译后得到的(修饰名字)可能不同。为了让c++语言写的程序能使用c语言程序，需要使用extern "C"使得这段代码可链接。

### 无链接性
无链接性(no linkage)的名字具有局部作用域。如局部变量、函数形参等。

### 类的链接性
参考自cpp-primer 3rd chapter 13.11 p562。类具有内部链接性，因此一个程序可以存在多份类的定义，但是要保证类的定义在各处完全一致。但是在一个编译单元中，同一个类只能被定义一次。<br>
**一种标准的做法是**：将名字空间中类定义在头文件中，在需要引入类的文件中进行包含。需要注意的是：类定义中非inline函数成员、static数据成员具有外部链接性，它们在整个程序中只能提供一个定义，它们的定义不应当放在头文件中，而是放在被使用的程序文件中。

### 补充内容
**[extern]**关键字，可以参考[这篇博客](/cpp/2021/04/22/post-cpp-extern/)。<br>
**[编译器名字修饰]** 可以参考[这个网址](https://zh.wikipedia.org/wiki/名字修饰)进行了解。

## Reference
> wikipedia 链接性质 <br>
> https://stackoverflow.com/questions/1358400/what-is-external-linkage-and-internal-linkage <br>
> https://en.wikipedia.org/wiki/Single_Compilation_Unit

> 1 当使用inline数学公式且公式经过GFM排版之后都在同一行 使用`$...$`符号<br>
> 2 当希望数学公式单独成行或者经过GFM排版之后占用多行 应当使用`$$...$$`符号<br>
> 3 对于表示条件概率 需要表示竖线的时候`|` 应当使用`\mid` 而不是直接在键盘上打出`|` => 容易被编辑器认为是一个md制表符<br>
> 4 在md引入图片的时候 不要使用`<center>`和`</center>` 在这篇文档的编辑过程中vscode的preview插件在使用了上述符号之后 导致下一段的数学公式预览显示不正常<br>
> 5 使用md的时候 单独的两段文字上下需要空出一行<br>
> 6 想要强制换行的时候 需要使用`<br>`而不是`<enter>`<br>
> 7 特殊字符如果想要避免和md解析关键字冲突 应当使用``将关键字包含在内
