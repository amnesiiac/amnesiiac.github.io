---
layout: post
title: "tcp-ip: broadcast & multicast (广播和多播)"
subtitle: '[tcp-ip: illustrated vol1] - chapter11' 
author: "twistfatezz"
header-style: text
# header-img: "img/in-post/economics_1/headimg.png"
# header-mask: 0.8
comments: false 
mathjax: false 
date: 2021-09-01 19:20
lang: ch 
catalog: true 
categories: tcp-ip 
tags:
  - Time 2021
  - tcp-ip illustrated vol1 
---
### 一：引言
IP地址大致可以分成3种类型：单播地址、广播地址、多播地址。本文主要介绍广播地址和多播地址。<br>
广播和多播发送数据包的方式只适用于UDP数据报而不是TCP，TCP是面向连接的协议，即两台主机上的两个进程(端口)之间存在TCP连接。

**[1] 单播&广播** <br>
通常情况下，每个以太网帧只发送给一个目的主机，目的地址指向单个主机上的接受端口，称之为单播(unicast)。使用unicast时，源端、目的端主机之间的通信除争夺共享信道的情况之外，不会影响到其他主机通信。<br>
然而，当一个以太网帧的目的主机是网络上所有其他主机时，成为广播(broadcast)；前几章介绍的ARP、RARP协议请求发送可以观察到广播数据报的发送机制。介于广播和多播之间的数据报传递方式称为多播(multicast)，即数据只发送给多播组内部的主机。

**[2] 广播方式传递数据报的弊端** <br>
广播针对网络上所有主机，并不是网络上的所有主机都应该响应该广播数据报应答，因此无形中增加了非相关主机的处理负荷。例如：网络中有50台主机，只有20台参与该应用程序，其余30台主机不得不处理该数据报，直到UDP网络层，该广播数据报才被丢弃(与应用程序端口号不匹配)。<br>

**[3] 多播较广播的优势** <br>
多播方式传递数据报解决了这个问题。网络上的主机通过加入一个or多个多播组，网卡获悉所有主机的组别后，按照特定分组进行多播，大大地减少了网络主机的冗余以太网帧处理负担。

**[4] 回顾各层次协议栈对收到的以太网数据帧的处理过程** <br>
<center><img src="/img/in-post/tcp-ip_img/broadcast_multicast_1.pdf" width="70%"></center>

### 二：广播
##### 1 受限制的广播(limited broadcast)
**[1] 定义** <br>
受限制的广播指的是：网络上的路由器不能转发目的地址为受限地址的广播数据报(任何情况下路由器都不会转发)，即受限的广播数据报只能在不经过路由器的本地网络内部进行传播。<br>
受限的本地网络广播地址为255.255.255.255，该地址为源端主机配置数据报的目的地址。

**[2] 多接口主机的受限广播数据报的发送** <br>
在多接口主机发送受限的广播数据报时，为了实现数据报的受限网络广播，是否向源端主机上的所有接口都发送该广播数据报？或者事先确定源端主机中所有支持广播的接口，然后向每一个支持广播的接口发送一份受限广播数据报的复制。<br>
大多数BSD系统将255.255.255.255作为配置完成后第一个接口的广播地址，并且不提供向主机具备广播能力的接口传送数据报的功能。但是routed和rwhod服务程序采用相似的启动流程以确定主机上所有接口信息，并获悉哪些接口具备广播能力，然后将每个支持广播的接口中配置的"net-directed"广播地址作为发往该端口的数据报的目的地址???problem😫problem???。<br>
Host Requirements RFC中规定并没有涉及对于多穴主机是否应该向其所有接口均发送受限广播数据报。

##### 2 指向网络的广播(unlimited broadcast)
指向网络的广播地址为主机号全为1的地址。<br>
例如A类网络广播地址为netid.255.255.255，其中netid为A类地址的网络号。网络号、主机号的区分需要结合目的IP地址以及子网掩码。<br>
默认情况下，路由器必须转发转发指向网络的广播数据报，但是它必须有一个选项对该数据报不进行转发。

##### 3 指向子网的广播(unlimited broadcast)
指向子网的广播的地址为主机号全为1，但是有特定的子网号的地址。是否为指向子网的广播地址需要结合IP地址和子网掩码共同判断。<br>
例如：发往目的地址为128.1.2.255(B类网络)的数据报，当B类网络128.1的子网掩码为255.255.255.0时，是一个指向子网的广播地址；如果子网掩码为255.255.254.0，那么该地址不是指向子网的广播地址(主机号不全为1)。

##### 4 指向所有子网的广播(unlimited broadcast)
指向所有子网的广播地址为子网号和主机号为全1的地址。<br>
例如，发往目的地址为128.1.255.255的广播数据报，当B类网络128.1.255的子网掩码为255.255.255.0，那么该数据报目的地址为指向所有子网的广播地址。

**不转发该类型数据报** 根据[Almquist 1993]，这种指向所有子网的广播是obsolete，更好的替代方式是多播而不是对所有子网的广播。RFC-922要求将指向所有子网的广播数据报发送给所有的子网，但是路由器并不会执行该规定(不转发是明智的)。

**为什么不转发是明智的** 当路由器子网掩码配置错误时，也可能将所有广播按照指向所有子网的形式发布；为了网络中错误配置的主机传播无用信息占用带宽，路由器对该类型数据报不进行转发。例如：IP地址为128.1.2.3的主机未配置子网掩码，则一般地该主机的广播地址默认值为128.1.255.255。如果错误地将该主机的子网掩码配置成255.255.255.0，那么该主机发送的广播数据报将总是指向所有子网。

### 三：广播的案例分析
##### 1 案例：通过ping程序研究广播与ARP高速缓存的互动关系
**[1] ping程序案例涉及的140.252.13.0网络主机结构图** <br>
<center><img src="/img/in-post/tcp-ip_img/broadcast_multicast_2.pdf" width="70%"></center>

**[2] ping程序研究广播发送数据报前后ARP高速缓存的变化** <br>
使用ping程序发送ICMP回显数据报到广播IP地址为140.252.13.63的网络中(如上图)，打印结果如下。
<center><img src="/img/in-post/tcp-ip_img/broadcast_multicast_3.pdf" width="100%"></center>

**[3] 分析上述ping程序运行前后源主机ARP高速缓存的变化原因** <br>
ping程序运行之前ARP高速缓存为空，运行ping程序后，ARP高速缓存中存放了所有本地网络的其他主机的"IP-MAC"地址信息。<br>
**(i)** sun主机在使用ping程序广播发送ICMP回显请求的时候不需要使用ARP服务，因为广播数据报只需固定发往广播IP地址即可，而无需获悉所有目的主机的IP-MAC地址；因此ARP高速缓存列表并不是广播发送请求时填充的。<br>
**(ii)** 当广播数据报的接受主机echo服务程序以单播方式返回ICMP回显数据报时，需要先发送ARP请求(请求源端主机的MAC地址)。在广播目的主机发送的ARP请求中，包含自身的IP/MAC地址，因此源端主机收到该请求并返回应答的过程中，填写ARP高速缓存表。

##### 2 tftp服务程序尝试向广播地址发送数据
**[4] 使用tftp服务程序向广播地址发送广播数据报** <br>
<center><img src="/img/in-post/tcp-ip_img/broadcast_multicast_4.pdf" width="100%"></center>
引发上述tftp程序发生差错的原因是：tftp服务程序不支持广播方式发送数据报。

**[5] 广播方式发送UDP数据的限制因素** <br> 可编程接口为程序提供的API应该在程序进程明确表示需要使用广播方式发送数据时才允许它向广播地址发送UDP数据报。因此，在广播方式发送UDP数据报之前，程序必须设置"SO_BROADCAST"选项。<br>
但是并不是所有系统都应用上述限制，有的系统无需进程说明即可直接广播发送UDP数据报，有的系统需要超级用户权限才能进行广播。

##### 3 使用ping程序研究广播数据报的转发
**[6] 使用ping程序研究路由器对广播数据报的转发机制** <br> 
通过路由器特定选项、主机的内核程序可以允许or禁止广播数据报的转发。

slip主机上运行ping程序向网络发送广播数据报，打印ICMP回显输出，可观察到广播数据报经bsdi转发的情况(bsdi设置允许转发广播数据报)。
<center><img src="/img/in-post/tcp-ip_img/broadcast_multicast_5.pdf" width="100%"></center>
上述转发广播数据报的流程大致如：**i** bsdi主机接受slip主机发送的广播数据报。**ii** 确定数据报的广播目的地址通过那个接口进行转发(对应哪个接口的广播地址)。**iii** 封装成以太网帧进行链路层广播。

上述ping程序输出结果中带有"DUP!"，它表明ICMP回显应答的16bit序列号(icmp_seq)重复了；由于通过广播方式发送，因此一份ICMP回显请求(特定序列号)将会得到多个ICMP回显应答(多份复制的序列号)，序列号重复是显然的。

### 四：多播
##### 1 引言
IP多播主要负责两类服务：<br>
**(i)** 向多个目的地址传送数据，即向多个接受者传递信息的应用。例如：交互式会议系统，邮件组群发邮件、新闻。不采用多播，使用TCP也可以完成：向多播的每个目的地址传递一份数据报的拷贝(很多应用使用TCP方式完成多播以保证传输的可靠性)。<br>
**(ii)** 客户端对于服务器的请求使用多播发送(solicitation of server by clients)，例如：无盘工作站(diskless workstation)向多个启动引导服务器发送请求。目前此项服务使用广播来完成(chapter16 BOOTP)，多播用于降低网络中不提供无盘系统引导服务的主机的负担。

##### 2 多播组地址
**[1] 多播组地址的格式** <br>
不同于其他A、B、C三类地址，多播组地址后28bit专门用来表示多播组号。多播地址的范围为：224.0.0.0 -\> 239.255.255.255。
<center><img src="/img/in-post/tcp-ip_img/broadcast_multicast_6.pdf" width="60%"></center>

**[2] 接受多播组数据的主机组** <br>
多播组数据报发往的目的主机集合称之为主机组(host group)。主机组可以跨越多个网络；主机组的成员可以随时添加删除；主机组的成员数量没有限制。<br>
一些知名的多播主机组被IANA确定为"永久主机组"，这个概念和TCP/UDP中熟知端口类似。需要注意的是，虽然这些主机组是永久的，但是它们的组成员却不永久(可以变动)。<br>
一些典型的主机组如：224.0.0.1(该子网所有系统组)，224.0.0.2(该子网内所有路由器组)，224.0.1.1(网络时间NTP)，224.0.0.9(RIP-2协议)。

##### 3 多播组地址到以太网地址的转换
**[0] 以太网多播地址型制的来源** <br>
**i** 以太网地址来源于IANA(international assigned numbers association)所分配的一个地址块：所有高24bit位为"00:00:5e"的地址集合，即地址块的范围为：00:00:5e:00:00:00 ~ 00:00:5e:ff:ff:ff。<br>
**ii** IANA将此地址块的一半用于分配以太网多播地址，即用于广播的以太网地址范围为：01:00:5e:00:00:00 ~ 01:00:5e:7f:ff:ff。<br>
**iii** 为了区分多播地址和普通地址，指明前2byte为"01"进行标识。

**[1] 多播组地址到以太网地址之间的映射关系(不需要借助ARP/RARP)**
<center><img src="/img/in-post/tcp-ip_img/broadcast_multicast_7.pdf" width="90%"></center>

**[2] 每个以太网地址对应的多个多播组地址** <br>
根据上图很容易发现，28bit多播组ID在映射到以太网地址时，低23bit直接复制，高5bit被忽略。因此只要低23bit能够匹配的多播组地址都可以作为以太网地址的映射源。
<center><img src="/img/in-post/tcp-ip_img/broadcast_multicast_8.pdf" width="100%"></center>

**[3] 多播以太网数据帧的过滤** <br>
既然多播的48bit以太网地址(硬件地址)到32bitIP地址(协议地址)之间的映射不是唯一的，网卡根据MAC地址进行数据帧收发，因此网卡可能会接收到主机不需要的多播数据帧(将不需要的数据帧过滤掉)。即多播的以太网帧可以发送到除多播组之外的以太网上的主机上(这些主机虽然不属于多播目的主机，但是由于它们除了5bit丢弃位其他都和多播组IP地址相同，因此也会收到多播的数据报)。

如果网卡不提供数据帧过滤功能，那么设备驱动程序必须接受所有数据帧并进行过滤。网卡过滤可通过2种方式：**i** 根据多播地址的hash数值对接受的以太网帧进行过滤(滤除hash值不符合要求的以太网帧)。**ii** 网卡只接受固定的多播地址，但这意味着网卡想接受预支持的以太网地址之外的多播地址时，需要设置网卡为"多播混杂模式(multicast promiscuous)"。

以上两种网卡过滤以太网数据帧的方式都不能完美解决数据帧的过滤问题(只使用48bitMAC地址进行过滤不能过滤完全)，因此还是需要设备驱动程序对于收到的数据帧进行检查，以进一步过滤(使用较高层次协议IP/ARP等进行进一步过滤)。

即使存在地址映射以及需要配置硬件过滤的问题，多播仍然好于广播。

**[4] 多播在单个物理网络 & 需要借助路由转发的网络中的应用** <br>
**单个物理网络上的传递** <br> 多播进程将目的IP地址指明为多播地址，设备驱动程序负责将目的IP地址(协议地址)转换为以太网地址(硬件地址)，然后发送数据。接收进程首先通知IP层，想要接受发往给定多播地址的数据报，并且收到的多播帧能够通过设别驱动程序的过滤；这个过程称为"加入多播组"。另外，同一个接收主机上可能存在多个进程用于接受多播数据帧，当主机上的进程收到一份多播数据帧时，会向每一个属于该多播组的进程传递一份该数据帧的copy。

**需要借助路由转发的网络上的传递** <br>
相比上一种类型的多播数据帧发送，这种情况复杂的多。需要使用IGMP(internet group management protocol)协议用于通知网络上的路由器：哪些主机属于特定多播组。

##### 4 FDDI以及令牌环网络中的多播
FDDI网络使用和以太网相同的映射方式(从32bit协议地址->48bitFDDI地址)。<br>
令牌环程序通常使用不同的映射方式(收到令牌环控制程序的限制)。

### 五：小结 
广播将以太网帧数据发送到网络中的所有主机，多播是将以太网数据发送到网络上的一个主机组。区分两种以太网帧发送方式是在网卡、设备驱动程序上的帧过滤。

目前有四种类型的广播方式：受限的广播、指向网络的广播、指向子网的广播和指向所有子网的广播。最常用的是指向子网的广播，受限制的广播通常只有系统初始启动时才使用。

D类IP地址通常称为多播组地址，通过映射其低23bit协议地址到以太网地址即可获得传输需要的硬件地址。需要注意的是，这种地址转换不是唯一的，因此需要其他高层的协议栈辅助进行帧过滤、数据报过滤。


## Reference
> \<tcp-ip: illustrated vol1\> chapter12 <br>

> 1 当使用inline数学公式且公式经过GFM排版之后都在同一行 使用`$...$`符号<br>
> 2 当希望数学公式单独成行或者经过GFM排版之后占用多行 应当使用`$$...$$`符号<br>
> 3 对于表示条件概率 需要表示竖线的时候`|` 应当使用`\mid` 而不是直接在键盘上打出`|` => 容易被编辑器认为是一个md制表符<br>
> 4 在md引入图片的时候 不要使用`<center>`和`</center>` 在这篇文档的编辑过程中vscode的preview插件在使用了上述符号之后 导致下一段的数学公式预览显示不正常<br>
> 5 使用md的时候 单独的两段文字上下需要空出一行<br>
> 6 想要强制换行的时候 需要使用`<br>`而不是`<enter>`<br>
> 7 特殊字符如果想要避免和md解析关键字冲突 应当使用``将关键字包含在内 <br>
> 8 `<center><img src="/img/in-post/economics_4/xxx.png" width="60%"></center>` <br>
> 9 使用html设置图片文字环绕方式: <br>
    `<div>` <br>
        `<img src="/img_path" align="left" width="40%" hspace="" vspace=""/>` <br>
        `<p>paragraph1 around the picture</p>` <br>
        `<p>paragraph2 around the picture</p>` <br>
        `<p>paragraph3 around the picture</p>` <br>
    `</div>` <br>
> 10 `<font style="color:red; font-weight:bold">加粗蓝色</font>`用来设置字体颜色 <br>
> 问题脚注: ### ???problem😫problem???
