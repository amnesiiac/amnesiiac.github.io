---
layout: post
title: "concurrent upload to artifactory via RESTful api (shell, artifactory)"
author: "melon"
date: 2023-12-26 19:29
categories: "2023"
tags:
  - shell
  - artifactory
---

### # shell script code walk
the script below is to deploy the apks generated by alpine linux APKBUILD into remote JFrog artifactory,
which utilize the provided RESTful api to avoid uploading apk to remote already existed,
each upload process can work concurrently.
```text
#!/bin/bash
# set -x

: "${REPODEST:=$HOME/packages}"
: "${OLDINDEX:=APKINDEX.tar.gz.old}"
: "${BASEURL:=https://artifactory-xxxxx:443}"

# upload to artifactory url using curl + RESTful api, return httpcode to indicate failure or success
upload() {
    repo=$1
    arch=$2
    apk=$3
    count=${4:-3}
    retry=0
    while true; do
        response=$(curl -s -w "%{http_code}" -H "X-JFrog-Art-Api:${CI_ALPINE_DEPLOY_KEY}" \
            -X PUT "$BASEURL/artifactory/rebornlinux-generic-local/alpine/v$ALPINE_VER/$repo/$arch/" \
            -T "$apk")

        http_code=$(echo "$response" | grep -oE '[0-9]{3}$')
        if [[ $http_code == 2* ]]; then
            echo "success upload $apk to $repo/$arch, http Status Code: $http_code, retry=$retry"
            return 0
        else
            echo "failed to upload $apk to $repo/$arch, http Status Code: $http_code, retry=$retry"
            if [ $retry -lt $count ]; then
                retry=$((retry+1))
                sleep 10
                continue
            else
                return 1
            fi
        fi
    done
}

# get all apk list entries under certain dir path in json format (see ut test 1)
retrieve_entries() {
    repo=$1
    arch=$2
    count=${3:-3}  # set default val if $3 not present
    retry=0
    while true; do
        # query the url to get response (ending with ?list)
        # CI_ALPINE_DEPLOY_KEY=AKCp8hyinctVijrdqGaFc1YAT7e7KDHWJEaackjuv6oCheipkYU9jU5okRj8rnFkVvcZWnTVc
        response=$(curl -s -w "%{http_code}" -H "X-JFrog-Art-Api:${CI_ALPINE_DEPLOY_KEY}" \
            "$BASEURL/artifactory/api/storage/rebornlinux-generic-local/alpine/v$ALPINE_VER/$repo/$arch/?list")
        http_code=$(echo "$response" | grep -oE '[0-9]{3}$')
        if [[ $http_code == 2* ]]; then
            echo "$response"
            return 0
        else
            if [ $retry -lt $count ]; then
                retry=$((retry+1))
                sleep 10
                continue
            else
                return 1
            fi
        fi
    done
}

# get incremental apk list to be uploaded
apks_latest() {
    repo=$1
    arch=$2
    cd "${REPODEST}/$repo/$arch" || exit 1
    new_apks=""

    # if OLDINDEX is not exist, the first time of uploading, upload all
    if [ ! -f "${OLDINDEX}" ]; then
        new_apks=$(ls | grep -v APKINDEX.tar.gz)
    else
        apks=$(ls | grep -v APKINDEX.tar.gz | grep -v "${OLDINDEX}")  # find all apks newer than APKINDEX.tar.gz
        for apk in $apks; do
            if [ "$apk" -nt "${OLDINDEX}" ]; then
                new_apks="$new_apks $apk"
            fi
        done
    fi
    echo "$new_apks"
}

# determine whether the apk pending to be uploaded is already existed in artifactory by sha1sum
existed_in_artifact() {
    db=$1
    repo=$2
    arch=$3
    apk=$4
    apk_sha1sum=""
    # get sha1sum result from returned json for certain apk
    db_sha1sum=$(echo "$db" | jq . | grep -A 5 "/$apk" | grep "sha1" | awk -F '"' '{print $4}')
    if [ -z "$db_sha1sum" ]; then
        return 1
    fi

    apk_path="${REPODEST}/$repo/$arch/$apk"
    if [ -f "$apk_path" ]; then
        apk_sha1sum=$(sha1sum "$apk_path" | awk '{print $1}')
    fi

    if [ x"$db_sha1sum" == x"$apk_sha1sum" ]; then
        return 0
    else
        return 1
    fi
}

# deploy procedure, call the above functions to upload (safe for concurrently invoked)
deploy() {
    repo=$1
    arch=$2
    cd "${REPODEST}/$repo/$arch" || exit 1

    apks_upload=""
    failed_upload=""
    success_upload=""

    apks_upload="$(apks_latest "$repo" "$arch" | xargs)"
    if [ -z "$apks_upload" ]; then
        echo "$repo/$arch: no apks need upload"
        return 0
    fi

    db_entries=$(retrieve_entries "$repo" "$arch")

    for apk in $apks_upload; do
        if [ -n "$db_entries" ] && existed_in_artifact "$db_entries" "$repo" "$arch" "$apk"; then
            echo "$repo/$arch: $apk already exist, skip upload"
            continue
        fi
        if upload "$repo" "$arch" "$apk"; then
            success_upload="$success_upload $apk"
        else
            failed_upload="$failed_upload $apk"
        fi
    done

    if [ -n "$failed_upload" ]; then
        echo "$repo/$arch: apks upload failed: $failed_upload"
        exit 1
    fi

    if [ -n "$success_upload" ]; then
        if upload "$repo" "$arch" "APKINDEX.tar.gz"; then
            echo "$repo/$arch: apks upload success: $success_upload APKINDEX.tar.gz"
        else
            echo "$repo/$arch: APKINDEX.tar.gz upload failed"
            exit 1
        fi
    fi

}

# main
# concurrently deploy apk to artifactory
pids=()
fail_cnt=0

echo $REPODEST
repos=$(find "${REPODEST}" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | xargs)
for repo in $repos; do
    archs=$(find "${REPODEST}/$repo" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | xargs)
    for arch in $archs; do
        deploy "$repo" "$arch" &  # concurrently invoke deploy procedure (run in background)
        pids+=($!)                # get the pid of the last background running jobs
    done
done

# wait for all background processes to finish
for pid in ${pids[@]}; do
    wait "$pid"
    exit_status=$?
    if [ $exit_status -ne 0 ]; then
        fail_cnt=$((fail_cnt+1))
        echo "FAIL: process $pid exit with $exit_status"
    else
        echo "SUCCESS: process $pid exit with $exit_status"
    fi
done

# judge whether all subprocess exit successfully
if [ $fail_cnt -ne 0 ]; then
    exit 1
fi
```

ut test for function retrieve_entries:
```text
#!/bin/sh

ALPINE_VER=3.18
CI_ALPINE_DEPLOY_KEY=AKCp8hyinctVijrdqGaFc1YAT7e7KDHWJEaackjuv6oCheipkYU9jU5okRj8rnFkVvcZWnTVc
BASEURL=https://artifactory-xxxxx:443

test_retrieve_entries() {
    repo=$1
    arch=$2
    count=${3:-3}  # set default val if $3 not present
    retry=0
    while true; do
        # query the url to get response all file entries list in json format (ending with ?list)
        response=$(curl -s -w "%{http_code}" -H "X-JFrog-Art-Api:${CI_ALPINE_DEPLOY_KEY}" \
            "$BASEURL/artifactory/api/storage/rebornlinux-generic-local/alpine/v$ALPINE_VER/$repo/$arch/?list")
        http_code=$(echo "$response" | grep -oE '[0-9]{3}$')
        if [[ $http_code == 2* ]]; then
            echo "$response"
            return 0
        else
            if [ $retry -lt $count ]; then
                retry=$((retry+1))
                sleep 1
                continue
            else
                return 1
            fi
        fi
    done
}

res=$(test_retrieve_entries main ppc64 3)
echo "$res" | head -n 20
echo
echo "..."
echo
echo "$res" | tail -n 10
```

the ut test result is as:
```text
{
  "uri" : "https://artifactory-xxxxx:443/artifactory/api/storage/rebornlinux-generic-local/alpine/v3.18/main/ppc64",
  "created" : "2024-02-06T12:05:23.343+05:30",
  "files" : [ {
    "uri" : "/APKINDEX.tar.gz",
    "size" : 26839,
    "lastModified" : "2024-01-17T15:43:05.660+05:30",
    "folder" : false,
    "sha1" : "f70f3d98726c3f586e6c3859a28a32b86f54a97d",
    "sha2" : "a78b08af7a5760e52ef0d8b1cf4d81b6264c2d1331f097c13b506b3af1ac2345"
  }, {
    "uri" : "/abuild-3.11.1-r0.apk",
    "size" : 88349,
    "lastModified" : "2024-01-16T12:30:19.897+05:30",
    "folder" : false,
    "sha1" : "b55cbbe57ff9c20a74f2a8f2fcef2217a43cbd8c",
    "sha2" : "eb0214638573cb1e6ee05f8202e799c38a0505db4b7c38872be90d81ebc902c9"
  }, {
    "uri" : "/abuild-doc-3.11.1-r0.apk",
    "size" : 11744,

...

    "sha2" : "aecf30079f9c5abe98a2e1c2f817f75bb2b97f72c4b2cdf534db857466225ac7"
  }, {
    "uri" : "/zstd-static-1.5.5-r4.apk",
    "size" : 3467873,
    "lastModified" : "2024-01-16T13:16:36.934+05:30",
    "folder" : false,
    "sha1" : "29bdeef7fe0eff33e0406074cd046b9d8c678e19",
    "sha2" : "3a6dfcae1a31cac87d504c0b9a085d54ee8d3116dd7fe949d3e0ab4d11659441"
  } ]
}200
```

<hr>

### # code in action
ref: /rebornlinux/aports/ci/deploy.sh

