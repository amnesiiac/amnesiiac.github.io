---
layout: post
title: "docker in docker & docker outside of docker (docker)"
author: "melon"
date: 2022-10-21 22:38
categories: "2022"
tags:
  - container
---
### # docker outside of docker
Just imitate a fake docker inside wrapper docker by communicating with host machine container-daemon via `/var/run/docker.sock`.
```text
docker pull docker    # using https://hub.docker.com/_/docker
docker run -it -v /var/run/docker.sock:/var/run/docker.sock docker
```
The above command create dood by mounting host docker.sock into wrapper docker container, let inner docker work as real dind.

Then, try `docker ps` command in inner docker, which shows the docker process same as host:
```text
/ # docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED         STATUS         PORTS                    NAMES
61cfa31d5d38   docker      "docker-entrypoint.s…"   2 seconds ago   Up 2 seconds                            frosty...
0217d4c3cab4   transhell   "trans -shell"           9 hours ago     Up 9 hours                              affect...
1174e94326db   blog        "/bin/bash"              6 days ago      Up 6 days      0.0.0.0:4000->4000/tcp   funnyy...
5eb859c35cf5   nvim        "/bin/bash"              12 days ago     Up 12 days                              inspir...
```
If want to build dood with self-defined image, try this:
```text
docker pull alpine
```
The command below mount host sock into container, note that we can communicate with docker-daemon by the mounted unix socket.
```text
# listen the docker daemon action: host docker action print json through sock
docker run -it -v /var/run/docker.sock:/var/run/docker.sock alpine sh
curl --unix-socket /var/run/docker.sock http://localhost/events
```
The command below mount host docker into docker container:
```text
docker run -it -v /var/run/docker.sock:/var/run/docker.sock \
               -v /usr/bin/docker:/usr/bin/docker ubuntu /bin/bash
docker ps -a   # will print the docker process of host
```
The command below mount host docker into docker container with alpine, which compiled with musl but not glibc, mounted binary file docker may not work as normal, see [stackoverflow](https://stackoverflow.com/a/66974607) as an example:
```text
docker run -it -v /var/run/docker.sock:/var/run/docker.sock \
               -v /usr/bin/docker:/usr/bin/docker alpine sh
docker ps -a   # will result in 'sh: docker: not found' even in ${PATH}
```
To illustrate the dood with textpaint:
```txt
  ┌──host─────────────────────────┐
  │┌─wrapper─────────────────────┐│  docker outside of docker (dood)
  ││┌docker client──────────────┐││  + wrapper docker
  │││             +             │││      - maintain the docker client
  ││└─────────────|─────────────┘││      - communicate with server via docker.sock
  │└──────────────|──────────────┘│  + host daemon
  │     /var/run/docker.sock      │      - the same level as wrapper docker
  │┌─docker daemon|──────────────┐│      - work as docker server for client
  ││              +              ││  + dood is parallel docker server / client
  ││                             ││  + docker client = container
  │└─────────────────────────────┘│
  └───────────────────────────────┘
```
For those who just want to use docker cli inside wrapper docker, and no caring about the hierarchical relationship between containers.

<hr>

### # docker inside docker
Using official dind image, which startup with a real docker daemon running inside. Note that need `--privileged` option to elevate the privileged of docker process.
```text
docker pull docker:20.10.12-dind
docker run --privileged --name $(container_name) docker:20.10.12-dind
```
Attach container using bash:
```text
docker exec -it $(container_name) /bin/sh
```
Run `ps` command to see the process running in the wrapper container:
```text
/ # ps
PID   USER     TIME  COMMAND
    1 root      0:00 docker-init -- dockerd --host=unix:///var/run/docker.sock --host=tcp://0.0.0.0:2376 --tlsverify --tlscacert /certs/serv
   57 root      0:00 dockerd --host=unix:///var/run/docker.sock --host=tcp://0.0.0.0:2376 --tlsverify --tlscacert /certs/server/ca.pem --tls
   64 root      0:00 containerd --config /var/run/docker/containerd/containerd.toml --log-level info
  171 root      0:00 /bin/sh
  186 root      0:00 ps
```
To illustrate the dind relationship with textpaint:
```txt
  ┌──host─────────────────────────┐  docker in docker (dind)
  │┌─wrapper docker──────────────┐│  + wrapper docker:
  ││┌docker client──────────────┐││      - need to run in privileged mode
  │││             +             │││  + inclusion docker:
  ││└─────────────|─────────────┘││      - whole docker app inside
  ││       /var/run/socket       ││  + docker-client
  ││┌docker daemon|─────────────┐││      - listen user input
  │││             +             │││  + unix docker.sock as the middleware
  ││└───────────────────────────┘││      - transfer the message up/down
  │└─────────────────────────────┘│  + dind is truely docker inside docker
  └───────────────────────────────┘
```

<hr>

### # Reference
> https://hub.docker.com/\_/docker <br>
> https://www.nixknight.com/2022/01/dind-vs-dood/ <br>
