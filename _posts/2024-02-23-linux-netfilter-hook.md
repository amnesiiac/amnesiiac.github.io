---
layout: post
title: "netfilter hooks (linux, network)"
author: "melon"
date: 2024-02-23 23:12
categories: "2024"
tags:
  - linux
  - network
---

### # packet flow in netfilter and general networking
the PREPARE HANDLING STEP is as:
```txt
                                                                                     
                                                 ┌─────────────────────────────────────(a)
                                                 │         clone pkt
                                                 │
                                                 │
                      ┌─────────┐           ┌────+────┐
                      │userspace│           │taps e.g.│
                      │(AF_XDP) │           │AF_PACKET│
                      └────+────┘           └────+────┘
                           │                     │                           ┌─────────(b)
                           │                     │                           │         
                           │                     │                           │         
                           │                     │                           │         
               XDP_REDIRECT│            clone pkt│                           │         
                           │                     │                           │         
     ┌─────┐          ┌────┴────┐ XDP_PASS  ┌────┴────┐     ┌───────┐     ┌──┴───┐     
     │start├─────────>│XDP(eBPF)├──────────>│alloc_skb├────>│ingress├────>│bridge├─────(c)
     └─────┘          └────┬────┘           └─────────┘     │(qdisc)│     │check │
                           │      XDP_TX                    └───────┘     └──────┘
                           └───────────────────────────────────────────────────────────(d)
```

the INPUT PATH is as:
```txt

       ┌---------------------------------------------------------------------------------------------------┐
       |                                       INPUT PATH                                                  |
     ┌-|---------------------------------------------------------------------------------------------------|---
     | | APPLICATION LAYER                                                                                 |
     | |                                                                                           ┌───────|─────(a)
     | |                                                                                           │       |
     └-|-------------------------------------------------------------------------------------------│-------|---
     ┌-|-------------------------------------------------------------------------------------------│-------|---
     | | PROTOCOL LAYER  ┌───────────┐                                                       ┌─────┴─────┐ |
(a)────|─────────────────┤xfrm decode+───────────────────────────────────────────────────────+xfrm/socket│ |
     | |                 │e.g. ipsec │                                                       │  lookup   │ |
     | |                 └───────────┘                                                       └─────+─────┘ |
     └-|-------------------------------------------------------------------------------------------│-------|---
     ┌-|-------------------------------------------------------------------------------------------│-------|---
     | | NETWORK LAYER                                                                        ┌────┴────┐  |
     | |                                                                                      │  filter │  |
     | |                                                                                      ├─────────┤  |
     | |                                                                                      │  input  │  |
     | |                                                                                      └────+────┘  |
     | |                                                                                      ┌────┴────┐  |
     | |                                                                                      │   nat   │  |
     | |                                                                                      ├─────────┤  |
     | |                                                                                      │  input  │  |
     | |                                                                                      └────+────┘  |
     | |                                                                                      ┌────┴────┐  |
     | |                                                                                      │  mangle │  |
     | |                                                                                      ├─────────┤  |
     | |                                                                                      │  input  │  |
     | |                               ┌──────────┐               ┌──────────┐  ┌──────────┐  └────+────┘  |
     | |                               │   raw    │               │  mangle  │  │   nat    │  *────┴────*  |
     | |                               ├──────────┤  ┌─────────┐  ├──────────┤  ├──────────┤  │ routing │  |
(b)────|───────────────────────────────+prerouting├──+conntrack├──+prerouting├──+prerouting├──+descision├──|─────(b)
     | |                               └──────────┘  └─────────┘  └──────────┘  └──────────┘  *────+────*  |
     └-|-------------------------------------------------------------------------------------------│-------|---
     ┌-|-------------------------------------------------------------------------------------------│-------|---
     | | LINK LAYER                                                                            ┌───┴────┐  |
     | |                                                                                       │ filter │  |
     | |                                                                                       ├────────┤  |
     | |                                                                                       │ input  │  |
     | |     ┌────────┐  ┌──────────┐  ┌──────────┐               ┌──────────┐  ┌──────────┐   └───+────┘  |
     | |     │ broute │  │   nat    │  │   raw    │               │  mangle  │  │   nat    │  *────┴────*  |
     | |     ├────────┤  ├──────────┤  ├──────────┤  ┌─────────┐  ├──────────┤  ├──────────┤  │ bridge  │  |
(c)────|─────+brouting├──+prerouting├──+prerouting├──+conntrack├──+prerouting├──+prerouting├──+descision├──|─────(c)
     | |     └────────┘  └──────────┘  └──────────┘  └─────────┘  └──────────┘  └──────────┘  *─────────*  |
     └-|---------------------------------------------------------------------------------------------------|---
       └---------------------------------------------------------------------------------------------------┘

```

the FORWARD PATH is as:
```txt
       ┌-------------------------------------------------┐
       |                  FORWARD PATH                   |
    ---|-------------------------------------------------|---
       | APPLICATION LAYER        ┌──────────────┐       |
(a)────|──────────────────────────+local process ├───────|─────(a)
       |                          └──────────────┘       |
    ---|-------------------------------------------------|---
    ---|-------------------------------------------------|---
       | PROTOCOL LAYER                                  |
       |                                                 |
    ---|-------------------------------------------------|---
       |                                                 |
    ---|-------------------------------------------------|---
       | NETWORK LAYER                                   |
       |                                                 |
       |                                                 |
       |                  ┌─────────┐  ┌─────────┐       |
       |                  │ mangle  │  │ filter  │       |
       |                  ├─────────┤  ├─────────┤       |
(b)────|────────────┬─────+ forward ├──+ forward ├───────|─────(b)
       |            │     └─────────┘  └─────────┘       |
    ---|------------│------------------------------------|---
    ---|------------│------------------------------------|---
       | LINK LAYER │                                    |
       |            │     ┌─────────┐  ┌─────────┐       |
       |            │     │ mangle  │  │ filter  │       |
       |            │     ├─────────┤  ├─────────┤       |
       |            └─────+ forward ├──+ forward ├───────|─────(b)
       |                  └─────────┘  └─────────┘       |
       |     ┌─────────┐  ┌─────────┐  ┌─────────┐       |
       |     │ filter  │  │ mangle  │  │ filter  │       |
       |     ├─────────┤  ├─────────┤  ├─────────┤       |
(c)────|─────+ forward ├──+ forward ├──+ forward ├───────|─────(c)
       |     └─────────┘  └─────────┘  └─────────┘       |
    ---|-------------------------------------------------|---
       └-------------------------------------------------┘

```

the OUTPUT PATH is as:
```txt

       ┌------------------------------------------------------------------------------------┐
       |                                   OUTPUT PATH                                      |
    ---|------------------------------------------------------------------------------------|-┐
       | APPLICATION LAYER                                                                  | |
(a)────|────────────┐                                                                       | |
    ---|------------│-----------------------------------------------------------------------|-┘
    ---|------------│-----------------------------------------------------------------------|-┐
       | PROTOCOL   │         not clone to *──────────*                                     | |
       | LAYER      │          AF_PACKET   │   xfrm   │                                     | |
       |            │             ┌────────┤  encode  +────────────────────────────┐        | |
       |            │             │        *──────────*                            │        | |
    ---|------------│-------------│------------------------------------------------│--------|-┘
       |            │             │                                                │        |
    ---|------------│-------------│------------------------------------------------│--------|-┐
       | NETWORK    │             │                                                │        | |
       | LAYER      │             │                                                │        | |
       |            │         ┌───+────┐                   ┌────────┐              │        | |
       |        *───+─────*   │  raw   │                   │  nat   │              │        | |
       |        │ routing │   ├────────┤   ┌───────────┐   ├────────┤              │        | |
       |        │ decision├───+ output ├───+ conntrack ├───+ output ├────┐         │        | |
       |        *─────────*   └────────┘   └───────────┘   └────────┘    │         │        | |
       |                                   ┌───────────┐   ┌────────┐    │         │        | |
       |                                   │  filter   │   │  nat   │    │         │        | |
       |                                   ├───────────┤   ├────────┤    │         │        | |
       |            ┌──────────────────────┤  output   +───┤ output +────┘         │        | |
       |            │                      └───────────┘   └────────┘              │        | |
       |            │                      ┌───────────┐  ┌───────────┐            │        | |
       |        *───+─────*                │  mangle   │  │    nat    │       *────┴───*    | |
       |        │ reroute │                ├───────────┤  ├───────────┤       │  xfrm  │    | |
(b)────|────────+ check   ├────────────────+postrouting├──+postrouting├───────+ lookup ├────|─|─────┐
       |        *───┬─────*                └───────────┘  └───────────┘       *────────*    | |     │
    ---|------------│-----------------------------------------------------------------------|-┘     │
    ---|------------│-----------------------------------------------------------------------|-┐     │
       | LINK LAYER │       ┌───────────┐  ┌───────────┐  ┌──────┐  ┌──────┐  ┌───────────┐ | |     │
       |            │       │  mangle   │  │    nat    │  │ nat  │  │filter│  │    nat    │ | |     │  clone
       |            │       ├───────────┤  ├───────────┤  ├──────┤  ├──────┤  ├───────────┤ | |     │  PACKET *─────────*
(b)────|────────────┴───────+postrouting├──+postrouting├──+output├──+output├──+postrouting├─|─|─────┤      ┌──+AF_PACKET│
       |                    └───────────┘  └───────────┘  └──────┘  └──────┘  └───────────┘ | |     │      │  *─────────*
       |     ┌───────────┐  ┌───────────┐  ┌───────────┐                                    | |     │      │
       |     │  filter   │  │  mangle   │  │    nat    │                                    | | *───+───*  │  *─────────*
       |     ├───────────┤  ├───────────┤  ├───────────┤                                    | | │egress ├──┘  │interface│
(c)────|─────+postrouting├──+postrouting├──+postrouting├────────────────────────────────────|─|─+(qdisc)├─────+ output  ├
       |     └───────────┘  └───────────┘  └───────────┘                                    | | *───────*     *───+─────*
    ---|------------------------------------------------------------------------------------|-┘                   │
       └------------------------------------------------------------------------------------┘                     │
    XDP_TX                                                                                                        │
(d)───────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

```

<hr>

### # reference
https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg
