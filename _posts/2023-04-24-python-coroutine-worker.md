---
layout: post
title: "coroutine context switch (python)"
author: "melon"
date: 2023-04-24 23:11
categories: "2023"
tags:
  - python
---

the following 2 examples is used to mimic coroutine context switches between simple tasks (no IO),
all process are in one python process.
the context switch is enabled by python build-in primitives: yield && next && send.
see toy code as follows:

```text
#!/usr/bin/env python3
import time

def task1():                                          # routine A: implemented as generator
    while True:                                       # sub-loop
        yield "<A> is tired, let <B> go to work"      # context switch to task2
        print("<A> work for a while.", end='\r')
        time.sleep(1)
        print("<A> work for a while..", end='\r')
        time.sleep(1)
        print("<A> work for a while...")
        time.sleep(1)

def task2(t):
    next(t)                                           # next(generator): skip the first yield call
    while True:                                       # main loop
        print("-----------------------------------")
        print("<B> work for a while.", end='\r')
        time.sleep(0.5)
        print("<B> work for a while..", end='\r')
        time.sleep(0.5)
        print("<B> work for a while...")
        time.sleep(0.5)
        print("<B> is tired, let <A> go to work")
        ret = t.send(None)                            # context switch to task1: pass None to generator & start it
        print(ret)                                    # print out the ret str generated by the generator
    t.close()

if __name__ == '__main__':
    t = task1()                                       # create a generator
    task2(t)                                          # assign to function task2
```

the above program output:

```text
-----------------------------------
<B> work for a while...
<B> is tired, let <A> go to work
<A> work for a while...
<A> is tired, let <B> go to work
-----------------------------------
<B> work for a while...
<B> is tired, let <A> go to work
<A> work for a while...
<A> is tired, let <B> go to work
-----------------------------------
<B> work for a while...
...
```
