---
layout: post
title: "flamegraph (program profiling)"
author: "melon"
date: 2023-10-10 20:25
categories: "2023"
tags:
  - profiling
  - ongoing
---

### # introduction to flamegraph
the manual form flamegraph.pl:

```text
USAGE: ./flamegraph.pl [options] infile > outfile.svg
$ ./flamegraph.pl --title="Flame Graph: malloc()" trace.txt > graph.svg

--title TEXT         # change title text
--subtitle TEXT      # second level title (optional)
--width NUM          # width of image (default 1200)
--height NUM         # height of each frame (default 16)
--minwidth NUM       # omit smaller functions (default 0.1 pixels)
--fonttype FONT      # font type (default "Verdana")
--fontsize NUM       # font size (default 12)
--countname TEXT     # count type label (default "samples")
--nametype TEXT      # name type label (default "Function:")
--colors PALETTE     # set color palette. choices are: hot (default), mem,
                     # io, wakeup, chain, java, js, perl, red, green, blue,
                     # aqua, yellow, purple, orange
--bgcolors COLOR     # set background colors. gradient choices are yellow
                     # (default), blue, green, grey; flat colors use "#rrggbb"
--hash               # colors are keyed by function name hash
--cp                 # use consistent palette (palette.map)
--reverse            # generate stack-reversed flame graph
--inverted           # icicle graph
--flamechart         # produce a flame chart (sort by time, do not merge stacks)
--negate             # switch differential hues (blue<->red)
--notes TEXT         # add notes comment in SVG (for debugging)
--help               # this message
```

<hr>

### # examples show how to create a flamegraph

```text
#include <iostream>
using namespace std;

int even(const int& n){
    return n;
}

int odd(const int& n){
    return n;
}

void bar(const int& n){
    for(int i=0; i<n; i++){
        if(i%2 == 0){
            even(n);
        }
        else{
            odd(n);
        }
    }
}

void baz(const int& n){
    bar(n);
}

int main(){
    baz(1000000);
    return 0;
}
```
compile the above program:
```text
$ g++ -Wall -o out test.cpp -g
```
using perf record/script to sampling data from binary executable file, and using perl script to generate flamegraph svg file.
```text
$ perf record -F 4000 -g -o perf.data ./out
$ perf script | ./stackcollapse-perf.pl | ./flamegraph.pl > data.svg
```

<hr>

### # flamegraph using sampling data generated by perf
```text
$ perf record -g -p ${pid} -- sleep ${time_to_record}
```

use perf script output data and perl script to generate flamegraph in svg format:

```text
$ perf script | ./stackcollapse-perf.pl | ./flamegraph.pl --width 720 > out.svg
```

<hr>

### # perf report for a tui overview
Use report to generate report in text format:
```text
$ perf report --stdio -ng
```
```text
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 43  of event 'cycles:u'
# Event count (approx.): 9811965
#
# Children      Self       Samples  Command  Shared Object        Symbol                 
# ........  ........  ............  .......  ...................  .......................
#
    86.31%     1.94%             1  out      libc-2.17.so         [.] __libc_start_main
            |          
            |--84.37%--__libc_start_main
            |          main
            |          baz
            |          |          
            |          |--76.50%--bar
            |          |          |          
            |          |          |--11.88%--odd
            |          |          |          
            |          |           --3.57%--even
            |          |          
            |          |--6.04%--odd
            |          |          
            |           --1.82%--even
            |          
             --1.94%--0x41d589495541f689
                       __libc_start_main

    84.37%     0.00%             0  out      out                  [.] main
            |
            ---main
               baz
               |          
               |--76.50%--bar
               |          |          
               |          |--11.88%--odd
               |          |          
               |           --3.57%--even
               |          
               |--6.04%--odd
               |          
                --1.82%--even
...
```

<hr>

### # reference
https://www.brendangregg.com/flamegraphs.html  
https://github.com/brendangregg/FlameGraph/blob/master/README.md

